<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotating 3D Object with Backface Culling</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        canvas {
            border: 1px solid #000;
        }
        .controls {
            margin-left: 20px;
        }
        .controls input {
            width: 100px;
        }
    </style>
</head>
<body>
    <canvas id="canvas" width="400" height="400"></canvas>
    <div class="controls">
        <input type="file" id="objFileInput" accept=".obj">
        <button id="startButton">Start Rotation</button>
        <button id="showAllButton">Show All Faces</button>
        <button id="cullBackfacesButton">Cull Backfaces</button>
        <br>
        <label>View Vector (X, Y, Z):</label>
        <select id="viewX">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="-1">-1</option>
        </select>
        <select id="viewY">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="-1">-1</option>
        </select>
        <select id="viewZ">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="-1">-1</option>
        </select>
        <br>
        <label>Scale:</label>
        <input type="number" id="scaleInput" value="1" step="0.1">
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const showAllButton = document.getElementById('showAllButton');
        const cullBackfacesButton = document.getElementById('cullBackfacesButton');
        const viewXInput = document.getElementById('viewX');
        const viewYInput = document.getElementById('viewY');
        const viewZInput = document.getElementById('viewZ');
        const scaleInput = document.getElementById('scaleInput');
        const objFileInput = document.getElementById('objFileInput');

        let rotation = 0;
        let isRotating = false;
        let object = { vertices: [], faces: [] };
        let cullBackfaces = true;

        function parseObjFile(text) {
            const vertices = [];
            const faces = [];

            text.split('\n').forEach(line => {
                const parts = line.trim().split(/\s+/);
                if (parts[0] === 'v') {
                    vertices.push([parseFloat(parts[1]), parseFloat(parts[2]), parseFloat(parts[3])]);
                } else if (parts[0] === 'f') {
                    const face = parts.slice(1).map(part => {
                        const indices = part.split('/').map(Number);
                        return indices[0] - 1; // OBJ indices are 1-based
                    });
                    faces.push(face);
                }
            });

            return { vertices, faces };
        }

        function rotatePoint(point, angle) {
            const [x, y, z] = point;
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);
            return [
                x * cos - z * sin,
                y,
                x * sin + z * cos
            ];
        }

        function scalePoint(point, scale) {
            return point.map(coord => coord * scale);
        }

        function projectPoint(point) {
            const [x, y, z] = point;
            return [
                x + canvas.width / 2,
                y + canvas.height / 2
            ];
        }

        function drawObject() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const viewVector = [
                parseFloat(viewXInput.value),
                parseFloat(viewYInput.value),
                parseFloat(viewZInput.value)
            ];

            const scale = parseFloat(scaleInput.value);

            object.faces.forEach(face => {
                const [p1, p2, p3] = face.slice(0, 3).map(index => object.vertices[index]);
                const v1 = p2.map((val, i) => val - p1[i]);
                const v2 = p3.map((val, i) => val - p1[i]);
                const normal = [
                    v1[1] * v2[2] - v1[2] * v2[1],
                    v1[2] * v2[0] - v1[0] * v2[2],
                    v1[0] * v2[1] - v1[1] * v2[0]
                ];

                const dotProduct = normal[0] * viewVector[0] + normal[1] * viewVector[1] + normal[2] * viewVector[2];

                if (!cullBackfaces || dotProduct < 0) {
                    ctx.beginPath();
                    face.forEach((index, i) => {
                        const point = scalePoint(rotatePoint(object.vertices[index], rotation), scale);
                        const [x, y] = projectPoint(point);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.closePath();
                    ctx.fillStyle = 'gray';
                    ctx.fill();
                    ctx.stroke();
                }
            });

            if (isRotating) {
                rotation += 0.01;
                requestAnimationFrame(drawObject);
            }
        }

        objFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    object = parseObjFile(e.target.result);
                    drawObject();
                };
                reader.readAsText(file);
            }
        });

        startButton.addEventListener('click', () => {
            isRotating = !isRotating;
            if (isRotating) {
                drawObject();
            }
        });

        showAllButton.addEventListener('click', () => {
            cullBackfaces = false;
            drawObject();
        });

        cullBackfacesButton.addEventListener('click', () => {
            cullBackfaces = true;
            drawObject();
        });

        // Update view vector when any of the select elements change
        [viewXInput, viewYInput, viewZInput].forEach(select => {
            select.addEventListener('change', drawObject);
        });

        // Update scale when the input element changes
        scaleInput.addEventListener('input', drawObject);

        // Set default view vector to show all faces
        viewXInput.value = '0';
        viewYInput.value = '0';
        viewZInput.value = '-1';
    </script>
</body>
</html>